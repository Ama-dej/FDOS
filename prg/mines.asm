[BITS 16]
[ORG 0x0000]

%DEFINE SELECTED_ATTRIBUTE 0xE0

	MOV AX, 0x1003
        MOV BL, 0x00
        INT 0x10 ; Turn off blinking attribute.

	MOV AX, 0x0001
	INT 0x10 ; Set to 40x25 with 16 colours.

	MOV AH, 0x01
        MOV CX, 0x2607
        INT 0x10 ; Make the cursor invisible.

	MOV AH, 0x08
	XOR BH, BH
	INT 0x10

	MOV WORD[PREVIOUS_ATTRIBUTE], AX

UPDATE_SELECTED:
	MOV AH, 0x09
	MOV AL, BYTE[PREVIOUS_ATTRIBUTE]
	MOV BL, BYTE[PREVIOUS_ATTRIBUTE + 1]
	AND BL, 0x0F
	OR BL, SELECTED_ATTRIBUTE
	XOR BH, BH
	MOV CX, 1
	INT 0x10

GET_KEY:
	XOR AH, AH
	INT 0x16

	OR AL, 0x20

	MOV DX, WORD[CURSOR_POSITION]

	CMP AL, 'a'
	JE MOVE_LEFT

	CMP AL, 'd'
	JE MOVE_RIGHT

	CMP AL, 'w'
	JE MOVE_UP

	CMP AL, 's'
	JE MOVE_DOWN

	CMP AL, 'f'
	JE PLACE_FLAG

	CMP AX, 0x013B
	JE EXIT

	JMP GET_KEY

MOVE_LEFT:
	TEST DL, DL
	JZ GET_KEY

	DEC DL
	JMP MOVE_CURSOR

MOVE_RIGHT:
	CMP DL, 39
	JAE GET_KEY

	INC DL
	JMP MOVE_CURSOR

MOVE_UP:
	TEST DH, DH
	JZ GET_KEY

	DEC DH
	JMP MOVE_CURSOR

MOVE_DOWN:
	CMP DH, 24
	JAE GET_KEY

	INC DH

MOVE_CURSOR:
	MOV AH, 0x09
	XOR BH, BH
	MOV AL, BYTE[PREVIOUS_ATTRIBUTE]
	MOV BL, BYTE[PREVIOUS_ATTRIBUTE + 1]
	MOV CX, 1
	INT 0x10

	MOV AH, 0x02
	INT 0x10

	MOV WORD[CURSOR_POSITION], DX

	MOV AH, 0x08
	INT 0x10

	MOV WORD[PREVIOUS_ATTRIBUTE], AX

	JMP UPDATE_SELECTED 

PLACE_FLAG:
	MOV AH, 0x09
	MOV AL, 0xD5
	MOV BL, (SELECTED_ATTRIBUTE & 0xF0) | 0x04
	MOV CX, 1
	INT 0x10

	MOV AH, BYTE[PREVIOUS_ATTRIBUTE + 1]
	AND AH, 0xF0
	AND BL, 0x0F
	OR AH, BL
	MOV WORD[PREVIOUS_ATTRIBUTE], AX
	
	JMP GET_KEY

EXIT:
	MOV AX, 0x0003
	INT 0x10

	XOR AH, AH
	INT 0x80

CURSOR_POSITION: DW 0
PREVIOUS_ATTRIBUTE: DW 0
